import{d as ce,C as I,D as T,S as M,z as d,ao as we,O as ie,I as c,u as q,K as Le,r as y,c as L,w as ne,Y as Fe,J as Me,R as z,G as Ne,L as Se,M as Te,N as _e,am as Ee,aj as Pe,ae as Ie,aa as oe}from"./element-plus-qgwGTzxg.js";import{i as F,f as P,h as K,j as H,c as W,o as se,k as De,l as Re,m as Oe}from"./utils-DWTWu0JZ.js";import{h as Ve,F as $e,d as re,u as Be,L as Ae}from"./mainAppView-035_X34S.js";const je=["onClick"],ze=ce({__name:"FileTree",props:{dataSource:{type:Array,required:!0},expendedKeys:{type:Array,default:()=>[]},defaultProps:{type:Object,default:()=>({children:"children",id:"path",label:"title"})},type:{type:String,default:""},readonly:{type:Boolean,default:!1},nodeClick:{type:Function,default:()=>{}},nodeContextmenu:{type:Function,default:()=>{}}},setup(h){const D=Ve();return(G,N)=>{const _=we;return T(),I("div",{class:M(["file-tree",h.type])},[d(_,{data:h.dataSource,props:h.defaultProps,"node-key":"id","default-expand-all":"","expand-on-click-node":!1,"default-expanded-keys":h.expendedKeys,onNodeContextmenu:N[0]||(N[0]=(r,C,u,k)=>{h.nodeContextmenu(r,C,u,k)})},{default:ie(({node:r,data:C})=>[c("span",{class:"node-item",onClick:u=>h.nodeClick(r,C)},[d($e,{name:r.data.title,folder:!r.isLeaf,"forder-open":r.expanded,light:!q(D)},null,8,["name","folder","forder-open","light"]),c("span",{class:M({label:!0,remote:C.data.position==="remote"})},Le(r.label),3)],8,je)]),_:1},8,["data","props","default-expanded-keys"])],2)}}}),Y=re(ze,[["__scopeId","data-v-7f78b28d"]]),Ke={class:"icon"},He={class:"content"},We={class:"title-item"},Ye={class:"selects"},qe={class:"icon"},Ge={class:"content"},Je={class:"icon"},Ue={class:"content"},Xe=ce({__name:"FilePanel",emits:["change:loading","change:tipLoad"],setup(h,{expose:D,emit:G}){const N=Be(),_=G,r=y(!1),C=L(()=>!F.ready);ne(()=>r.value,t=>{_("change:loading",t)},{immediate:!0}),ne(()=>C.value,t=>{_("change:tipLoad",t)},{immediate:!0});const u=L(()=>N.settings.repoName),k=y(u.value),x=y([]),g=y("mixed"),R={children:"children",id:"path",label:"title"},O=t=>(t.sort((e,n)=>e.isLeaf===n.isLeaf?e.title.localeCompare(n.title):e.isLeaf?1:-1),t.forEach(e=>{!e.isLeaf&&Array.isArray(e.children)&&e.children.length>0&&O(e.children)}),t),de=t=>{const e=[];return t.forEach(n=>{const l={title:n.path.substring(n.path.lastIndexOf("/")+1),isLeaf:n.type==="blob",isExpanded:!1,data:{path:n.path}};l.isLeaf&&(l.data.position="remote"),e.push(l)}),e},J=t=>{const e=[];return t.forEach(n=>{const l=n.split("/");for(let o=0;o<l.length;o++){const a=l.slice(0,o+1).join("/");if(!e.find(i=>i.data.path===a)){const i={title:l[o],isLeaf:o===l.length-1,isExpanded:!1,data:{path:a}};i.isLeaf&&(i.data.position="local"),e.push(i)}}}),e},ue=(t,e)=>{const n=[];return t.forEach(l=>{e.find(a=>a.data.path===l.data.path)||n.push(l)}),e.forEach(l=>{n.push(l)}),O(n)},V=t=>{const e={};t.forEach(l=>{e[l.data.path]={...l,children:[]}});const n=[];return t.forEach(l=>{const o=l.data.path.substring(0,l.data.path.lastIndexOf("/"));o&&e[o]?(e[o].children||(e[o].children=[]),e[o].children.push(e[l.data.path])):n.push(e[l.data.path])}),O(n)},U=y([]),$=y([]),X=y([]),Q=L(()=>{const t=de(U.value);return V(t)}),fe=L(()=>{const t=J($.value);return V(t)}),pe=L(()=>{const t=J(X.value);return V(t)}),ve=L(()=>ue(Q.value,fe.value)),S=async(t=!1)=>{r.value=!0,x.value=await K.listAllRepoNames();const e="local.inkstone";if(x.value.includes(e)||x.value.push(e),x.value.includes(u.value)||x.value.push(u.value),X.value=await K.list(k.value),F.ready){const n=await F.getRepoTree(t);U.value=n.tree.map(l=>({mode:l.mode||"",path:l.path||"",sha:l.sha||"",type:l.type||"",url:l.url||""})),$.value=await K.list(u.value)}r.value=!1};Fe(async()=>{S(),F.ready||(g.value="local")});const Z=async()=>{await S(!0),Ie({type:"success",message:"刷新成功!"})};D({createFile:()=>{P(null,u.value,"local",!1,!1,E)},refresh:Z});const B=(t,e,n)=>{if(!e.isLeaf)return;const l=n.data.path,o=N.settings.repoBranch;t==="mixed"?(H(l,u.value),$.value.push(l)):t==="local"?H(l,k.value):t==="remote"&&Oe(l,u.value,o)},E=(t,e)=>{S(),H(t,e)},A=t=>{se(t)},me=()=>{S(),r.value=!1},ee=(t,e,n,l)=>t.map(o=>({label:o.label,onClick:()=>{o.onClick&&o.onClick(e,n,l)},icon:o.icon,children:o.children?ee(o.children,e,n,l):void 0})),he={label:"文件",onClick:(t,e,n,l=!1,o=!1,a=E)=>{P(t,e,n,l,o,a)}},Ce={label:"新建文章",onClick:(t,e,n,l=!0,o=!1,a=E)=>{P(t,e,n,l,o,a)}},ke={label:"新建草稿",onClick:(t,e,n,l=!0,o=!0,a=E)=>{P(t,e,n,l,o,a)}},xe={label:"文件",onClick:(t,e,n,l=!1,o=!1,a=A)=>{W(l,o,a)}},ge={label:"新建文章",onClick:(t,e,n,l=!0,o=!1,a=A)=>{W(l,o,a)}},ye={label:"新建草稿",onClick:(t,e,n,l=!0,o=!0,a=A)=>{W(l,o,a)}},b={label:"新建",children:[Ce,ke,he]},f={label:"新建(本机)",children:[ge,ye,xe]},te={label:"重命名",onClick:()=>{}},ae={label:"复制",onClick:()=>{}},le={label:"删除",onClick:(t,e,n,l=me)=>{r.value=!0,De(t,e,n,l)}},j={label:"导出到本机磁盘",onClick:async(t,e,n)=>{if(t)if("showSaveFilePicker"in window){const l=await window.showSaveFilePicker({startIn:"desktop",suggestedName:t.title});Re(t,e,n,l)}else oe({title:"Warning",message:"抱歉，当前浏览器不支持打开本地文件",type:"warning"})}},p={label:"刷新",onClick:Z},be={label:"拷贝到",children:x.value.map(t=>({label:t,onClick:()=>{console.log("拷贝到",t)}}))},v={label:"打开本机文件",onClick:async()=>{if("showOpenFilePicker"in window){const[t]=await window.showOpenFilePicker({startIn:"desktop"});se(t),console.log(t)}else oe({title:"Warning",message:"抱歉，当前浏览器不支持打开本地文件",type:"warning"})}},w=(t,e,n=null,l=null,o=null)=>{e.stopPropagation(),e.preventDefault(),console.log("右击",t,n,l,o);let a=[],s=u.value;t==="mixed"?n?n.isLeaf?a=[b,f,te,ae,le,j,v,p]:a=[b,f,v,p]:a=[b,f,v,p]:t==="local"?(n?n.isLeaf?a=[b,f,te,ae,le,j,v,p,be]:a=[b,f,v,p]:a=[b,f,v,p],s=k.value):t==="remote"&&(n?n.isLeaf?a=[j,f,v,p]:a=[f,v,p]:a=[f,v,p]),Ae.showContextMenu({x:e.clientX,y:e.clientY,items:ee(a,n,s,t),zIndex:2017})};return(t,e)=>{const n=Ne("font-awesome-icon"),l=Ee,o=Pe;return T(),I("div",{class:M({tipLoad:C.value,"file-tree-box":!0,noLogin:!q(F).ready})},[q(F).ready?(T(),I("div",{key:0,class:M({current:g.value==="mixed",item:!0})},[c("div",{class:"title",onClick:e[0]||(e[0]=a=>g.value="mixed")},[e[7]||(e[7]=z(" 混合文件树 ")),c("div",Ke,[d(n,{class:"icon-left",icon:["fas","chevron-right"]}),d(n,{class:"icon-down",icon:["fas","chevron-down"]})])]),c("div",He,[d(Y,{type:"mixed",dataSource:ve.value,defaultProps:R,nodeClick:(a,s)=>B("mixed",a,s),nodeContextmenu:(a,s,i,m)=>{w("mixed",a,s,i,m),console.log(a,s,i,m)},onContextmenu:e[1]||(e[1]=a=>w("local",a))},null,8,["dataSource","nodeClick","nodeContextmenu"])])],2)):Me("",!0),c("div",{class:M({current:g.value==="local",item:!0})},[c("div",{class:"title",onClick:e[3]||(e[3]=a=>g.value="local")},[c("div",We,[e[8]||(e[8]=z(" 本地缓存文件 ")),c("div",Ye,[d(o,{class:"select-local-tree-repo",modelValue:k.value,"onUpdate:modelValue":e[2]||(e[2]=a=>k.value=a),"collapse-tags":"",placeholder:"Select","popper-class":"custom-header","max-collapse-tags":4,onChange:S},{default:ie(()=>[(T(!0),I(Se,null,Te(x.value,a=>(T(),_e(l,{key:a,label:a,value:a},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])])]),c("div",qe,[d(n,{class:"icon-left",icon:["fas","chevron-right"]}),d(n,{class:"icon-down",icon:["fas","chevron-down"]})])]),c("div",Ge,[d(Y,{type:"local",dataSource:pe.value,defaultProps:R,nodeClick:(a,s)=>B("local",a,s),nodeContextmenu:(a,s,i,m)=>{w("local",a,s,i,m),console.log(a,s,i,m)},onContextmenu:e[4]||(e[4]=a=>w("local",a))},null,8,["dataSource","nodeClick","nodeContextmenu"])])],2),c("div",{class:M({current:g.value==="remote",item:!0})},[c("div",{class:"title",onClick:e[5]||(e[5]=a=>g.value="remote")},[e[9]||(e[9]=z(" 远程仓库文件（只读） ")),c("div",Je,[d(n,{class:"icon-left",icon:["fas","chevron-right"]}),d(n,{class:"icon-down",icon:["fas","chevron-down"]})])]),c("div",Ue,[d(Y,{type:"remote",dataSource:Q.value,defaultProps:R,nodeClick:(a,s)=>B("remote",a,s),nodeContextmenu:(a,s,i,m)=>{w("remote",a,s,i,m),console.log(a,s,i,m)},onContextmenu:e[6]||(e[6]=a=>w("remote",a))},null,8,["dataSource","nodeClick","nodeContextmenu"])])],2)],2)}}}),tt=re(Xe,[["__scopeId","data-v-755ab628"]]);export{tt as default};
